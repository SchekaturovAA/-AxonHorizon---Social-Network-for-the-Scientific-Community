{% extends 'users/base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="card-title mb-0">–°–æ–æ–±—â–µ—Å—Ç–≤–∞</h4>
                <a href="{% url 'communities:community_create' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> –°–æ–∑–¥–∞—Ç—å —Å–æ–æ–±—â–µ—Å—Ç–≤–æ
                </a>
            </div>
            <div class="card-body">
                <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –º–æ–∏—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤ -->
                {% if user_communities %}
                <div class="mb-4">
                    <button class="btn btn-outline-primary w-100 text-start" type="button" data-bs-toggle="collapse" data-bs-target="#myCommunitiesCollapse" aria-expanded="false" aria-controls="myCommunitiesCollapse">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-users me-2"></i>
                                –ú–æ–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
                                <span class="badge bg-primary ms-2">{{ user_communities.count }}</span>
                            </span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </button>

                    <!-- –°–∫—Ä—ã–≤–∞–µ–º–∞—è –ø–∞–Ω–µ–ª—å —Å –º–æ–∏–º–∏ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞–º–∏ -->
                    <div class="collapse mt-3" id="myCommunitiesCollapse">
                        <div class="row">
                            {% for community in user_communities %}
                            <div class="col-md-4 mb-4">
                                <div class="card h-100 community-card">
                                    {% if community.avatar %}
                                    <img src="{{ community.avatar.url }}" class="card-img-top" alt="{{ community.name }}" style="height: 150px; object-fit: cover;">
                                    {% else %}
                                    <div class="bg-secondary d-flex align-items-center justify-content-center" style="height: 150px;">
                                        <span class="text-white fs-3">{{ community.name|first|upper }}</span>
                                    </div>
                                    {% endif %}
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">
                                            <a href="{% url 'communities:community_detail' community.id %}" class="text-decoration-none">
                                                {{ community.name }}
                                            </a>
                                        </h5>
                                        <p class="card-text text-muted small flex-grow-1">
                                            {{ community.short_description|default:community.description|truncatewords:15 }}
                                        </p>
                                        <div class="mt-auto">
                                            <div class="d-flex justify-content-between text-muted small">
                                                <span>üë• {{ community.member_count }}</span>
                                                <span>üìù {{ community.post_count }}</span>
                                            </div>
                                            {% if community.scientific_field %}
                                            <span class="badge bg-light text-dark mt-2">{{ community.scientific_field.name }}</span>
                                            {% endif %}

                                            <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –ß–ê–°–¢–¨ -->
                                            {% for membership in community.communitymembership_set.all %}
                                                {% if membership.user == request.user %}
                                                    {% if membership.role == 'admin' %}
                                                    <span class="badge bg-danger mt-1">–ê–¥–º–∏–Ω</span>
                                                    {% elif membership.role == 'moderator' %}
                                                    <span class="badge bg-warning text-dark mt-1">–ú–æ–¥–µ—Ä–∞—Ç–æ—Ä</span>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- –í—Å–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞ -->
                <div>
                    <h5 class="mb-4">
                        –í—Å–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–∞
                        <small class="text-muted">({{ communities.count }})</small>
                    </h5>

                    {% if communities %}
                    <div class="row">
                        {% for community in communities %}
                        <div class="col-md-4 mb-4">
                            <div class="card h-100 community-card">
                                {% if community.avatar %}
                                <img src="{{ community.avatar.url }}" class="card-img-top" alt="{{ community.name }}" style="height: 150px; object-fit: cover;">
                                {% else %}
                                <div class="bg-secondary d-flex align-items-center justify-content-center" style="height: 150px;">
                                    <span class="text-white fs-3">{{ community.name|first|upper }}</span>
                                </div>
                                {% endif %}
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title">
                                        <a href="{% url 'communities:community_detail' community.id %}" class="text-decoration-none">
                                            {{ community.name }}
                                        </a>
                                    </h5>
                                    <p class="card-text text-muted small flex-grow-1">
                                        {{ community.short_description|default:community.description|truncatewords:15 }}
                                    </p>
                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between text-muted small">
                                            <span>üë• {{ community.members_count }}</span>
                                            <span>üìù {{ community.posts_count }}</span>
                                            <span class="badge bg-secondary">{{ community.get_community_type_display }}</span>
                                        </div>

                                        <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ -->
                                        {% if community in user_communities %}
                                        <span class="badge bg-success mt-2">–í—ã —É—á–∞—Å—Ç–Ω–∏–∫</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-5">
                        <p class="text-muted">–°–æ–æ–±—â–µ—Å—Ç–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                        <a href="{% url 'communities:community_create' %}" class="btn btn-primary">–°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ—Å—Ç–≤–æ</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.community-card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.community-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

/* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞ */
.btn-outline-primary[aria-expanded="true"] .fa-chevron-down {
    transform: rotate(180deg);
    transition: transform 0.3s ease;
}

.btn-outline-primary .fa-chevron-down {
    transition: transform 0.3s ease;
}

/* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
.collapse.show {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}
</style>

<script>
// –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞
document.addEventListener('DOMContentLoaded', function() {
    const collapseElement = document.getElementById('myCommunitiesCollapse');
    const button = document.querySelector('[data-bs-target="#myCommunitiesCollapse"]');

    if (collapseElement && button) {
        collapseElement.addEventListener('show.bs.collapse', function () {
            button.setAttribute('aria-expanded', 'true');
        });

        collapseElement.addEventListener('hide.bs.collapse', function () {
            button.setAttribute('aria-expanded', 'false');
        });

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ localStorage
        button.addEventListener('click', function() {
            const isExpanded = button.getAttribute('aria-expanded') === 'true';
            localStorage.setItem('myCommunitiesExpanded', !isExpanded);
        });

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–∑ localStorage
        const savedState = localStorage.getItem('myCommunitiesExpanded');
        if (savedState === 'true') {
            const bsCollapse = new bootstrap.Collapse(collapseElement, {
                toggle: false
            });
            bsCollapse.show();
        }
    }
});
</script>
{% endblock %}
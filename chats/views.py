from django.contrib.auth.decorators import login_required
from django.shortcuts import render, get_object_or_404, redirect
from django.http import JsonResponse
from django.contrib import messages
from django.db.models import Q, Count
from django.db import models
from django.conf import settings
from django.utils import timezone
from .models import Chat, ChatMember, Message, MessageRead
from .forms import ChatForm, MessageForm, AddMembersForm
from users.models import User
from utils.mongo_cache import MongoCacheHelper
import time


@login_required
def chat_list(request):
    """Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‡Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ñ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼"""
    # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð· ÐºÑÑˆÐ° MongoDB
    cached_data = MongoCacheHelper.get_cached_chat_list(request.user.id)

    if cached_data:
        print("âœ… Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‡Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½ Ð¸Ð· ÐºÑÑˆÐ° MongoDB")
        return render(request, 'chats/chat_list.html', cached_data)

    print("ðŸ”„ Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‡Ð°Ñ‚Ð¾Ð² Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ÑÑ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…")

    # ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ‡Ð°Ñ‚Ð¾Ð² Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    user_chats = Chat.objects.filter(members=request.user).annotate(
        message_count=Count('messages'),
        last_message_time=models.Max('messages__created_at')
    ).order_by('-updated_at')

    # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÑ… Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°
    for chat in user_chats:
        try:
            chat_member = ChatMember.objects.get(chat=chat, user=request.user)
            unread_count = Message.objects.filter(
                chat=chat,
                created_at__gt=chat_member.last_read
            ).count()
            chat.unread_count = unread_count
        except ChatMember.DoesNotExist:
            chat.unread_count = 0

    # ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð´Ð»Ñ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
    context = {
        'chats': user_chats,
        'cache_timestamp': time.time()  # ÐœÐµÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
    }

    # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² ÐºÑÑˆ MongoDB Ð½Ð° 5 Ð¼Ð¸Ð½ÑƒÑ‚
    MongoCacheHelper.cache_chat_list(request.user.id, context)

    return render(request, 'chats/chat_list.html', context)


@login_required
def chat_detail(request, chat_id):
    """Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ñ‡Ð°Ñ‚Ð° Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÐ¼Ð¸ Ð¸ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼"""
    chat = get_object_or_404(Chat, id=chat_id, members=request.user)

    # ÐŸÑ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¸Ð· ÐºÑÑˆÐ° MongoDB
    cached_messages = MongoCacheHelper.get_cached_chat_messages(chat_id)

    if cached_messages:
        print("âœ… Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ñ‡Ð°Ñ‚Ð° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ñ‹ Ð¸Ð· ÐºÑÑˆÐ° MongoDB")
        messages_list = cached_messages
    else:
        print("ðŸ”„ Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ñ‡Ð°Ñ‚Ð° Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÑŽÑ‚ÑÑ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…")
        messages_list = list(chat.messages.all().order_by('created_at'))
        # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð² ÐºÑÑˆ MongoDB Ð½Ð° 5 Ð¼Ð¸Ð½ÑƒÑ‚
        MongoCacheHelper.cache_chat_messages(chat_id, messages_list)

    # ÐŸÐ¾Ð¼ÐµÑ‡Ð°ÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    try:
        chat_member = ChatMember.objects.get(chat=chat, user=request.user)
        unread_messages = chat.messages.filter(created_at__gt=chat_member.last_read)

        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÐ¸ Ð¾ Ð¿Ñ€Ð¾Ñ‡Ñ‚ÐµÐ½Ð¸Ð¸ Ð´Ð»Ñ Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
        for message in unread_messages:
            MessageRead.objects.get_or_create(user=request.user, message=message)

        # ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¿Ñ€Ð¾Ñ‡Ñ‚ÐµÐ½Ð¸Ñ
        chat_member.last_read = timezone.now()
        chat_member.save()
    except ChatMember.DoesNotExist:
        pass

    # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
    if request.method == 'POST':
        form = MessageForm(request.POST)
        if form.is_valid():
            message = form.save(commit=False)
            message.chat = chat
            message.author = request.user
            message.save()

            # Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ ÐºÑÑˆ Ñ‡Ð°Ñ‚Ð° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
            MongoCacheHelper.invalidate_chat_cache(chat_id)

            # Ð”Ð»Ñ AJAX Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ JSON
            if request.headers.get('x-requested-with') == 'XMLHttpRequest':
                return JsonResponse({'status': 'success'})

            # Ð”Ð»Ñ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ñ… Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¾Ð² - Ñ€ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚
            return redirect('chats:chat_detail', chat_id=chat.id)
    else:
        form = MessageForm()

    # Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚
    context = {
        'chat': chat,
        'messages_list': messages_list,
        'form': form,
        'cache_timestamp': time.time()  # ÐœÐµÑ‚ÐºÐ° Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸
    }

    return render(request, 'chats/chat_detail.html', context)


@login_required
def create_chat(request):
    """Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð°"""
    if request.method == 'POST':
        form = ChatForm(request.POST)
        if form.is_valid():
            # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ñ‡Ð°Ñ‚
            chat = form.save(commit=False)
            chat.chat_type = 'group'  # ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚Ð¸Ð¿ "Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹"
            chat.created_by = request.user
            chat.save()

            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð·Ð´Ð°Ñ‚ÐµÐ»Ñ Ð² Ñ‡Ð°Ñ‚ ÐºÐ°Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°
            ChatMember.objects.create(user=request.user, chat=chat, role='admin')

            # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
            user_ids = request.POST.getlist('users')
            added_users_count = 0
            for user_id in user_ids:
                try:
                    user = User.objects.get(id=user_id)
                    ChatMember.objects.get_or_create(user=user, chat=chat)
                    added_users_count += 1

                    # Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ ÐºÑÑˆ ÑÐ¿Ð¸ÑÐºÐ° Ñ‡Ð°Ñ‚Ð¾Ð² Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
                    MongoCacheHelper.invalidate_user_cache(user.id)
                except User.DoesNotExist:
                    continue

            # Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ ÐºÑÑˆ ÑÐ¿Ð¸ÑÐºÐ° Ñ‡Ð°Ñ‚Ð¾Ð² Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ñ‚ÐµÐ»Ñ
            MongoCacheHelper.invalidate_user_cache(request.user.id)

            # Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð± ÑƒÑÐ¿ÐµÑ…Ðµ
            if added_users_count > 0:
                messages.success(request, f"Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½! Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ {added_users_count} ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²")
            else:
                messages.success(request, "Ð“Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½! Ð’Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ð² Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ñ… Ñ‡Ð°Ñ‚Ð°")

            return redirect('chats:chat_detail', chat_id=chat.id)
        else:
            messages.error(request, "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¸ÑÐ¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð² Ñ„Ð¾Ñ€Ð¼Ðµ")
    else:
        form = ChatForm(initial={'chat_type': 'group'})

    # Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð´Ñ€ÑƒÐ·ÐµÐ¹ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ð¾Ð²Ð¾Ð¹ Ñ‡Ð°Ñ‚
    friends = request.user.get_friends()

    context = {
        'form': form,
        'friends': friends,
    }
    return render(request, 'chats/create_chat.html', context)


@login_required
def chat_settings(request, chat_id):
    """ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ñ‡Ð°Ñ‚Ð°"""
    chat = get_object_or_404(Chat, id=chat_id, members=request.user)

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð°Ð´Ð¼Ð¸Ð½Ñ‹ Ð¼Ð¾Ð³ÑƒÑ‚ Ð¼ÐµÐ½ÑÑ‚ÑŒ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸)
    try:
        user_membership = ChatMember.objects.get(chat=chat, user=request.user)
        user_role = user_membership.role
        if user_role != 'admin' and chat.created_by != request.user:
            messages.error(request, "Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Ñ‡Ð°Ñ‚Ð°")
            return redirect('chats:chat_detail', chat_id=chat.id)
    except ChatMember.DoesNotExist:
        messages.error(request, "Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Ñ‡Ð°Ñ‚Ð°")
        return redirect('chats:chat_detail', chat_id=chat.id)

    if request.method == 'POST':
        # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²
        if 'add_members' in request.POST:
            add_form = AddMembersForm(request.POST, current_chat=chat)
            if add_form.is_valid():
                users = add_form.cleaned_data['users']
                added_count = 0
                for user in users:
                    _, created = ChatMember.objects.get_or_create(user=user, chat=chat)
                    if created:
                        added_count += 1
                        # Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ ÐºÑÑˆ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
                        MongoCacheHelper.invalidate_user_cache(user.id)

                if added_count > 0:
                    messages.success(request, f"Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ {added_count} ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²")
                    # Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ ÐºÑÑˆ Ñ‡Ð°Ñ‚Ð°
                    MongoCacheHelper.invalidate_chat_cache(chat_id)
                else:
                    messages.info(request, "Ð’ÑÐµ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ ÑƒÐ¶Ðµ Ð±Ñ‹Ð»Ð¸ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°Ð¼Ð¸ Ñ‡Ð°Ñ‚Ð°")
                return redirect('chats:chat_settings', chat_id=chat.id)
            else:
                messages.error(request, "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¸ÑÐ¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð² Ñ„Ð¾Ñ€Ð¼Ðµ")
        else:
            # ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº Ñ‡Ð°Ñ‚Ð°
            form = ChatForm(request.POST, instance=chat)
            if form.is_valid():
                form.save()
                messages.success(request, "ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ñ‡Ð°Ñ‚Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹")
                # Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ ÐºÑÑˆ Ñ‡Ð°Ñ‚Ð°
                MongoCacheHelper.invalidate_chat_cache(chat_id)
                return redirect('chats:chat_settings', chat_id=chat.id)
            else:
                messages.error(request, "ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¸ÑÐ¿Ñ€Ð°Ð²ÑŒÑ‚Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ Ð² Ñ„Ð¾Ñ€Ð¼Ðµ")
    else:
        form = ChatForm(instance=chat)
        add_form = AddMembersForm(current_chat=chat)

    # ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð² Ñ‡Ð°Ñ‚Ð°
    members = ChatMember.objects.filter(chat=chat).select_related('user')

    context = {
        'chat': chat,
        'form': form,
        'add_form': add_form,
        'members': members,
    }
    return render(request, 'chats/chat_settings.html', context)


@login_required
def search_users(request):
    """ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð´Ð»Ñ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð² Ñ‡Ð°Ñ‚"""
    query = request.GET.get('q', '')
    if query:
        users = User.objects.filter(
            Q(username__icontains=query) |
            Q(first_name__icontains=query) |
            Q(last_name__icontains=query)
        ).exclude(id=request.user.id)[:10]
        results = [{'id': user.id, 'name': user.get_full_name() or user.username} for user in users]
    else:
        results = []

    return JsonResponse(results, safe=False)


@login_required
def remove_member(request, chat_id, user_id):
    """Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ° Ð¸Ð· Ñ‡Ð°Ñ‚Ð°"""
    chat = get_object_or_404(Chat, id=chat_id, members=request.user)
    user_to_remove = get_object_or_404(User, id=user_id)

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    try:
        user_membership = ChatMember.objects.get(chat=chat, user=request.user)
        user_role = user_membership.role
        if user_role != 'admin' and chat.created_by != request.user:
            messages.error(request, "Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²")
            return redirect('chats:chat_settings', chat_id=chat.id)
    except ChatMember.DoesNotExist:
        messages.error(request, "Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð¿Ñ€Ð°Ð² Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ¾Ð²")
        return redirect('chats:chat_settings', chat_id=chat.id)

    # ÐÐµ Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÐµÐ±Ñ Ð¸Ð· Ñ‡Ð°Ñ‚Ð°
    if user_to_remove == request.user:
        messages.error(request, "Ð’Ñ‹ Ð½Ðµ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÐµÐ±Ñ Ð¸Ð· Ñ‡Ð°Ñ‚Ð°")
    else:
        # Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑƒÑ‡Ð°ÑÑ‚Ð½Ð¸ÐºÐ°
        ChatMember.objects.filter(chat=chat, user=user_to_remove).delete()
        messages.success(request,
                         f"ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ {user_to_remove.get_full_name() or user_to_remove.username} ÑƒÐ´Ð°Ð»ÐµÐ½ Ð¸Ð· Ñ‡Ð°Ñ‚Ð°")

        # Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ ÐºÑÑˆ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
        MongoCacheHelper.invalidate_user_cache(user_to_remove.id)
        # Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ ÐºÑÑˆ Ñ‡Ð°Ñ‚Ð°
        MongoCacheHelper.invalidate_chat_cache(chat_id)

    return redirect('chats:chat_settings', chat_id=chat.id)


@login_required
def create_personal_chat(request, user_id):
    """Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ Ñ‡Ð°Ñ‚Ð° Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼"""
    other_user = get_object_or_404(User, id=user_id)

    # ÐÐµÐ»ÑŒÐ·Ñ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‡Ð°Ñ‚ Ñ ÑÐ°Ð¼Ð¸Ð¼ ÑÐ¾Ð±Ð¾Ð¹
    if other_user == request.user:
        messages.error(request, "ÐÐµÐ»ÑŒÐ·Ñ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‡Ð°Ñ‚ Ñ ÑÐ°Ð¼Ð¸Ð¼ ÑÐ¾Ð±Ð¾Ð¹")
        return redirect('users:user_profile', username=request.user.username)

    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð»Ð¸ ÑƒÐ¶Ðµ Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚ Ð¼ÐµÐ¶Ð´Ñƒ ÑÑ‚Ð¸Ð¼Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸
    existing_chat = Chat.objects.filter(
        chat_type='personal',
        members=request.user
    ).filter(members=other_user).distinct().first()

    if existing_chat:
        # Ð•ÑÐ»Ð¸ Ñ‡Ð°Ñ‚ ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚, Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð² Ð½ÐµÐ³Ð¾
        messages.info(request, "ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ Ðº ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‰ÐµÐ¼Ñƒ Ñ‡Ð°Ñ‚Ñƒ")
        return redirect('chats:chat_detail', chat_id=existing_chat.id)

    # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ Ñ‡Ð°Ñ‚
    chat = Chat.objects.create(
        chat_type='personal',
        created_by=request.user
    )

    # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¾Ð±Ð¾Ð¸Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð² Ñ‡Ð°Ñ‚
    ChatMember.objects.create(user=request.user, chat=chat, role='admin')
    ChatMember.objects.create(user=other_user, chat=chat, role='member')

    # Ð˜Ð½Ð²Ð°Ð»Ð¸Ð´Ð¸Ñ€ÑƒÐµÐ¼ ÐºÑÑˆ ÑÐ¿Ð¸ÑÐºÐ° Ñ‡Ð°Ñ‚Ð¾Ð² Ð´Ð»Ñ Ð¾Ð±Ð¾Ð¸Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
    MongoCacheHelper.invalidate_user_cache(request.user.id)
    MongoCacheHelper.invalidate_user_cache(other_user.id)

    messages.success(request, f"Ð§Ð°Ñ‚ Ñ {other_user.get_full_name() or other_user.username} ÑÐ¾Ð·Ð´Ð°Ð½")
    return redirect('chats:chat_detail', chat_id=chat.id)


# Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ñ… Ñ‡Ð°Ñ‚Ð¾Ð²
def get_unread_chats_count(user):
    """ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ñ‡Ð°Ñ‚Ð¾Ð² Ñ Ð½ÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ð¼Ð¸ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÑÐ¼Ð¸"""
    if not user.is_authenticated:
        return 0

    user_chats = Chat.objects.filter(members=user)
    unread_count = 0

    for chat in user_chats:
        try:
            chat_member = ChatMember.objects.get(chat=chat, user=user)
            unread_messages = Message.objects.filter(
                chat=chat,
                created_at__gt=chat_member.last_read
            ).count()
            if unread_messages > 0:
                unread_count += 1
        except ChatMember.DoesNotExist:
            continue

    return unread_count